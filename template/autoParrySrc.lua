return function(a)local b=a.Services;local c=a.Tabs;local d=a.References;local e=a.Library;local f=a.Options;local g=a.Toggles;local h=a.Unloader;local i=a.Helpers;local j=a.AutoParryConfig or{Enabled=false}local k=b.VirtualInputManager;local l=b.RunService;local m=b.Workspace;local n=b.HttpService;local o=b.Players;local p=os.clock;local q,r=table.insert,table.remove;local function s(t,u)if type(t)~="string"or t==""then return u end;if t:find("/")or t:find("\\")then return t end;return d.gameDir.."/"..t end;local function v(w)if type(w)~="string"then return nil end;local x=w:gsub("%s+","")return x~=""and x or nil end;local function y(z)local A={}if type(z)=="table"then for B,C in ipairs(z)do if type(C)=="table"then local D=tostring(C.Name or C.name or"Preset "..B)A[#A+1]={Name=D,Url=C.Url or C.url,EncryptedUrl=C.EncryptedUrl or C.encryptedUrl or C.EncryptedURL or C.encryptedURL,File=C.File or C.file,EncryptedExtraUrl=C.EncryptedExtraUrl or C.encryptedExtraUrl or C.EncryptedExtraURL or C.encryptedExtraURL,ExtraFile=C.ExtraFile or C.extraFile,Config=C.Config or C.config,ExtraConfig=C.ExtraConfig or C.extraConfig,PaidKey=v(C.PaidKey or C.paidKey or C.Key or C.key),PurchaseUrl=C.PurchaseUrl or C.purchaseUrl or C.PurchaseURL or C.purchaseURL,Default=C.Default==true or C.default==true}end end end;if#A==0 then A[1]={Name="Custom Config",File="AP_Config.json",ExtraFile="AP_Config_Extra.json",Default=true}end;return A end;local function E(F)local G={}if type(F)=="table"then for H,I in pairs(F)do G[H]=I end end;return G end;local function J()if type(a.ConfigSecrets)=="table"then return a.ConfigSecrets.Key or a.ConfigSecrets.ConfigKey or a.ConfigSecrets.AutoParryKey end;if type(a.AutoParrySecrets)=="table"then return a.AutoParrySecrets.Key or a.AutoParrySecrets.AutoParryKey end;return nil end;if j.Enabled~=true then return end;local K={MainConnections={},EnemyTracks={},AnimSeen=setmetatable({},{__mode="k"}),PendingParries={},RangeSq=14*14,FovThreshold=-1,ParryAvailTime=0}local L={ConfigPresets=y(j.Presets or j.ConfigPresets),DefaultConfig=type(j.DefaultConfig)=="table"and j.DefaultConfig or{},DefaultExtra=type(j.DefaultExtra)=="table"and j.DefaultExtra or{parryKey="F",rollKey="Q"},secretKey=J(),enabled=false,debug=false,pingOn=true,pingScale=100,extraBiasMs=0,range=14,useFov=false,fovLimit=180,parryFailTime=0.25,rollOnFailGlob=true,productionMode=true,keyCode=Enum.KeyCode.F,rollKey=Enum.KeyCode.Q,currentPresetIndex=1,apFile=d.gameDir.."/AP_Config.json",apExtraFile=d.gameDir.."/AP_Config_Extra.json",activeMainFile=nil,activeExtraFile=nil,AP_Config={},AP_ConfigExtra={}}local function M()return d.gameDir.."/AP_PaidKeys.json"end;local function N()if not(isfile and readfile)then return{}end;local t=M()if not isfile(t)then return{}end;local O,P=pcall(n.JSONDecode,n,readfile(t))if O and type(P)=="table"and type(P.keys)=="table"then return P.keys end;return{}end;local function Q(R)if not(writefile and R)then return false end;local S={keys=R}local O,T=pcall(n.JSONEncode,n,S)if O then pcall(writefile,M(),T)return true end;return false end;local function U(V)return type(V)=="table"and type(V.PaidKey)=="string"and V.PaidKey~=""end;local function W(V,X)if not U(V)then return true end;local Y=X and X[V.Name]return Y==V.PaidKey end;local function Z(z)for _,V in ipairs(z)do if U(V)then return true end end;return false end;L.PaidKeys=N()L.hasPaidConfigs=Z(L.ConfigPresets)local function a0()local a1=j.DefaultPreset;if type(a1)=="number"and L.ConfigPresets[a1]then return a1 end;if type(a1)=="string"then for B,V in ipairs(L.ConfigPresets)do if V.Name==a1 then return B end end end;for B,V in ipairs(L.ConfigPresets)do if V.Default==true then return B end end;return 1 end;local function a2()for B,V in ipairs(L.ConfigPresets)do if W(V,L.PaidKeys)then return B end end;return 1 end;local function a3()for B,V in ipairs(L.ConfigPresets)do if U(V)and W(V,L.PaidKeys)then return B end end;return nil end;local function a4()return L.ConfigPresets[L.currentPresetIndex]or L.ConfigPresets[1]end;local function a5(V)local a6=s(V and V.File,L.apFile)local a7=s(V and V.ExtraFile,L.apExtraFile)return a6,a7 end;L.currentPresetIndex=a0()local a8=a3()if a8 then L.currentPresetIndex=a8 end;if not W(a4(),L.PaidKeys)then L.currentPresetIndex=a2()end;L.lastPresetName=(L.ConfigPresets[L.currentPresetIndex]or{}).Name;local function a9(aa,ab)local ac,ad,ae=aa.X-ab.X,aa.Y-ab.Y,aa.Z-ab.Z;return ac*ac+ad*ad+ae*ae end;local function af(ag,ah)if not L.useFov then return true end;if not ag or not ah then return false end;local ai=(ah.Position-ag.Position).Unit;local aj=ag.CFrame.LookVector;return aj:Dot(ai)>=K.FovThreshold end;local function ak(al,am,an)if not L.debug or not e.Notify then return end;e:Notify({Title=al,Description=am or"",Time=an or 3})end;local function ao(ap)if ap then q(K.MainConnections,ap)end;return ap end;local function aq()if not d.humanoidRootPart then return end;local ar=p()for B=#K.PendingParries,1,-1 do local as=K.PendingParries[B]if ar>=as.triggerTime then local at,au=pcall(as.fn)if not at and L.debug then warn("[AutoParry] Exec Error:",au)end;r(K.PendingParries,B)end end end;ao(l.Heartbeat:Connect(aq))ao(d.player.CharacterAdded:Connect(function()table.clear(K.PendingParries)if L.debug then ak("Respawn","Queue Cleared",2)end end))local function av(w,aw)k:SendKeyEvent(true,w,false,game)task.spawn(function()task.wait(aw)k:SendKeyEvent(false,w,false,game)end)end;function L:executeParry(ax,ay,az,aA,aB)if not self.enabled then return end;local ag=d.humanoidRootPart;if not ag then return end;local ar=p()local aC=az and az.Name or"Unknown"if ar<K.ParryAvailTime then if self.rollOnFailGlob and ax.rollOnFail then av(self.rollKey,0.05)K.ParryAvailTime=ar+self.parryFailTime;if getgenv().AutoParry_OnParryFailRoll then pcall(getgenv().AutoParry_OnParryFailRoll,ay,ax,aC,aB)end;if not self.productionMode then ak("Roll","Conflict/CD: "..(ax.name or ay),2)end end;return end;if self.useFov and az then local aD=az:FindFirstChild("HumanoidRootPart")or az.PrimaryPart;if not af(ag,aD)then if self.debug then ak("FOV Fail","Enemy outside angle",1)end;return end end;local aE=ax.priority=="roll"local aF=aE and self.rollKey or self.keyCode;av(aF,ax.hold)K.ParryAvailTime=ar+self.parryFailTime;if getgenv().AutoParry_OnParryFired then pcall(getgenv().AutoParry_OnParryFired,ay,ax,aC,aB)end;if not self.productionMode then ak(aE and"Roll"or"Parry",ax.name or ay,2)end end;function L:schedule(ay,aG,az,ax)local ar=p()local aH=d.player:GetNetworkPing()local aI=self.pingOn and aH*0.5*self.pingScale/100 or 0;aI=math.max(0,aI+self.extraBiasMs/1000)local aJ=aG.TimePosition or 0;local aK={{t=ax.startSec,isRepeat=false}}if ax.repeats then for _,aL in ipairs(ax.repeats)do q(aK,{t=tonumber(aL),isRepeat=true})end end;local aM=0;if ax.distanceAdj~=0 and az and d.humanoidRootPart then local aD=az:FindFirstChild("HumanoidRootPart")or az.PrimaryPart;if aD then local aN=(aD.Position-d.humanoidRootPart.Position).Magnitude;aM=ax.distanceAdj*aN/100 end end;local aB=tostring(ay).."-"..tostring(math.floor(ar*1000))local aC=az and az.Name or"Unknown"for _,aO in ipairs(aK)do local aP=(aO.t or ax.startSec)+aM;local aQ=aP-aJ-aI;if getgenv().AutoParry_OnParryScheduled then pcall(getgenv().AutoParry_OnParryScheduled,ay,ax,aC,aQ,ar,aB)end;q(K.PendingParries,{triggerTime=ar+math.max(0,aQ),fn=function()if az and az.Parent then self:executeParry(ax,ay,az,aO.isRepeat,aB)end end})if not self.productionMode and self.debug then ak("Scheduled",("%.3fs delay"):format(aQ),1)end end end;function L:unhookHumanoid(aR)if K.EnemyTracks[aR]then for _,ap in ipairs(K.EnemyTracks[aR])do if ap.Connected then ap:Disconnect()end end;K.EnemyTracks[aR]=nil end end;function L:isValidTarget(aS)if not aS or aS==d.character then return false end;local aD=aS:FindFirstChild("HumanoidRootPart")or aS.PrimaryPart;local ag=d.humanoidRootPart;if not(aD and ag)then return false end;if a9(aD.Position,ag.Position)>K.RangeSq then return false end;return true end;function L:processAnim(aT)if not aT then return end;local aR=aT.Parent;if not aR then return end;if K.EnemyTracks[aR]then return end;local aU={}local aV=aR.AnimationPlayed:Connect(function(aW)if not self.enabled then return end;if K.AnimSeen[aW]then return end;local aS=aR.Parent;if not self:isValidTarget(aS)then return end;local aX=aW.Animation and aW.Animation.AnimationId or""local ay=aX:match("%d+")if not ay then return end;local ax=self.AP_Config[ay]if not ax or ax.enabled==false then return end;K.AnimSeen[aW]=true;self:schedule(ay,aW,aS,ax)end)q(aU,aV)local aY=aR.AncestryChanged:Connect(function(_,aZ)if not aZ then self:unhookHumanoid(aR)end end)q(aU,aY)K.EnemyTracks[aR]=aU end;function L:Start()if self.enabled then return end;self.enabled=true;for _,I in ipairs(m:GetDescendants())do if I:IsA("Animator")then self:processAnim(I)end end;if not self.descAdd then self.descAdd=ao(m.DescendantAdded:Connect(function(I)if I:IsA("Animator")then self:processAnim(I)end end))end;ak("Auto Parry","Enabled",2)end;function L:Stop()self.enabled=false;table.clear(K.PendingParries)ak("Auto Parry","Disabled",2)end;local function a_(t)if not(isfile and isfile(t))then return nil end;local O,b0=pcall(readfile,t)return O and type(b0)=="string"and b0 or nil end;local function b1(b0)if type(b0)~="string"then return nil end;local O,b2=pcall(function()if crypt and crypt.base64 and crypt.base64.decode then return crypt.base64.decode(b0)elseif bit and bit.base64 and bit.base64.decode then return bit.base64.decode(b0)end;return n:JSONDecode('"'..b0 ..'"')end)if O and type(b2)=="string"then return b2 end;return nil end;local function b3(b4,w)if type(b4)~="string"or b4==""then return nil end;if type(w)~="string"or w==""then return nil end;if not(bit32 and bit32.bxor)then return nil end;local b5=table.create(#b4)local b6=#w;for B=1,#b4 do local b7=string.byte(b4,B,B)local H=string.byte(w,(B-1)%b6+1,(B-1)%b6+1)b5[B]=string.char(bit32.bxor(b7,H))end;return table.concat(b5)end;local function b8(b9,w)if type(b9)~="string"then return nil,"invalid payload"end;if type(w)~="string"or w==""then return nil,"missing key"end;local b4=b1(b9)if not b4 then return nil,"base64 decode failed"end;local ba=b3(b4,w)if not ba then return nil,"xor decrypt failed"end;return ba end;local function bb(t)local bc=a_(t)return bc and tostring(#bc)..":"..string.sub(bc,1,64)or"nil"end;local function bd(be)if type(be)~="table"then return be end;local bf={be.Config,be.config,be.Anims,be.anims,be.Animations,be.animations,be.Data,be.data,be.Entries,be.entries}for _,bg in ipairs(bf)do if type(bg)=="table"then return bg end end;return be end;local function bh(bi)local O,P=pcall(n.JSONDecode,n,bi)if O then if type(P)=="string"then local bj,bk=pcall(n.JSONDecode,n,P)if bj then return bk end end;return P end;return nil end;local function bl(bi,bm)if type(bi)~="string"then return nil end;local P=bh(bi)if P then return P end;if bm and L.secretKey then local S=bi:gsub("%s+","")local ba=b8(S,L.secretKey)if ba then P=bh(ba)if P then return P end end end;return nil end;local function bn(be)be=bd(be)if type(be)~="table"then return{}end;local bo={}for bp,bc in pairs(be)do if type(bc)=="table"then bo[bp]={name=bc.name or"Unknown",startSec=tonumber(bc.startSec)or 0,hold=tonumber(bc.hold)or 0.35,rollOnFail=bc.rollOnFail~=false,distanceAdj=tonumber(bc.distanceAdj)or 0,repeats=bc.repeats or{},priority=tostring(bc.priority or"parry"):lower(),enabled=bc.enabled~=false}end end;return bo end;local function bq()local br=a4()local bs=bn(L.DefaultConfig)local bt=E(L.DefaultExtra)local bu,bv="default",0;local a6,a7=a5(br)L.activeMainFile=a6;L.activeExtraFile=a7;if br and type(br.Config)=="table"then bs=bn(br.Config)bu="Injected: "..br.Name elseif br and br.EncryptedUrl then local at,bw=pcall(game.HttpGet,game,br.EncryptedUrl)if at then local P=bl(bw,true)if P then bs=bn(P)bu=br.Name else warn("[AutoParry] Encrypted config JSON invalid.")end end elseif br and br.Url then local at,bw=pcall(game.HttpGet,game,br.Url)if at then local P=bl(bw,true)if P then bs=bn(P)bu="Web: "..br.Name else warn("[AutoParry] Web config JSON invalid.")end end elseif a6 and isfile(a6)then local am=a_(a6)if am then local P=bl(am,false)if P then bs=bn(P)bu="File: "..(br and br.Name or"Custom")end end end;L.AP_Config=bs;if br and type(br.ExtraConfig)=="table"then for H,I in pairs(br.ExtraConfig)do bt[H]=I end elseif br and br.EncryptedExtraUrl then local at,bw=pcall(game.HttpGet,game,br.EncryptedExtraUrl)if at then local S=bw:gsub("%s+","")local ba,bx=b8(S,L.secretKey)if ba then local by,bc=pcall(n.JSONDecode,n,ba)if by and type(bc)=="table"then for H,I in pairs(bc)do bt[H]=I end end else warn("[AutoParry] Encrypted extra decrypt failed: "..tostring(bx))end end elseif a7 and isfile(a7)then local am=a_(a7)if am then local by,bc=pcall(n.JSONDecode,n,am)if by and type(bc)=="table"then for H,I in pairs(bc)do bt[H]=I end end end end;L.AP_ConfigExtra=bt;local bz=L.AP_ConfigExtra.parryKey or"F"local bA=L.AP_ConfigExtra.rollKey or"Q"L.keyCode=Enum.KeyCode[bz:upper()]or Enum.KeyCode.F;L.rollKey=Enum.KeyCode[bA:upper()]or Enum.KeyCode.Q;for _ in pairs(L.AP_Config)do bv=bv+1 end;return bu,bv end;bq()getgenv()._AP_AUTOREFRESH=getgenv()._AP_AUTOREFRESH or{}local bB=getgenv()._AP_AUTOREFRESH;if not bB._started then bB._started=true;bB.enabled=false;bB.lastMainSig=nil;bB.lastExtraSig=nil;task.spawn(function()while true do task.wait(1)if bB.enabled and bB.Callback then pcall(bB.Callback)end end end)end;bB.Callback=function()local V=a4()local bC=V and not V.Url and type(V.Config)~="table"local bD=V and type(V.ExtraConfig)~="table"local bE=bC and bb(L.activeMainFile)or bB.lastMainSig;local bF=bD and bb(L.activeExtraFile)or bB.lastExtraSig;if bE~=bB.lastMainSig or bF~=bB.lastExtraSig then bB.lastMainSig=bE;bB.lastExtraSig=bF;local bG,bH=bq()if e and e.Notify then e:Notify({Title="AutoParry Refreshed",Description=("%s (%d Anims)"):format(bG,bH),Time=4})end end end;local bI=c.Combat:AddRightGroupbox("Auto Parry","swords")bI:AddToggle("AP_Enable",{Text="Enable Auto Parry",Default=false}):AddKeyPicker("AP_ToggleKey",{Default=nil,SyncToggleState=true,Mode="Toggle"})bI:AddDropdown('AP_ConfigProfile',{Values=(function()local bJ={}for _,I in ipairs(L.ConfigPresets)do table.insert(bJ,I.Name)end;return bJ end)(),Default=(L.ConfigPresets[L.currentPresetIndex]or L.ConfigPresets[1]).Name,Multi=false,Text='Config Profile'})local function bK(V)local bL="This is a paid config submitted by a community member. The link to purchase has been copied to your clipboard."if V and V.PurchaseUrl then if i and i.copyLink then i.copyLink(V.PurchaseUrl,bL)return end;if setclipboard then pcall(setclipboard,V.PurchaseUrl)end end;if e and e.Notify then e:Notify(bL,4)end end;local function bM(bN)local w=v(bN)if not w then if e and e.Notify then e:Notify("Enter a paid config key.",3)end;return end;local bO={}for _,V in ipairs(L.ConfigPresets)do if U(V)and V.PaidKey==w then L.PaidKeys[V.Name]=w;table.insert(bO,V.Name)end end;if#bO>0 then Q(L.PaidKeys)if e and e.Notify then e:Notify("Unlocked paid config: "..table.concat(bO,", "),3)end elseif e and e.Notify then e:Notify("Invalid paid config key.",3)end end;if L.hasPaidConfigs then bI:AddInput("AP_PaidConfigKey",{Text="Paid Config Key",Placeholder="Enter key",Finished=true,Callback=function(bP)bM(bP)end})end;bI:AddSlider("AP_Range",{Text="Range",Default=14,Min=5,Max=50,Suffix=" studs"})bI:AddDivider()bI:AddToggle("AP_UseFov",{Text="Use FOV Check",Default=false})bI:AddSlider("AP_FovLimit",{Text="FOV Angle",Default=180,Min=45,Max=360,Suffix=" deg"})bI:AddDivider()bI:AddToggle("AP_Ping",{Text="Ping Compensation",Default=true})bI:AddSlider("AP_PingScale",{Text="Ping Scale",Default=100,Min=0,Max=150,Suffix="%"})bI:AddSlider("AP_Bias",{Text="Extra Bias",Default=0,Min=-150,Max=150,Suffix=" ms"})bI:AddDivider()bI:AddToggle("AP_RollOnFail",{Text="Roll on Fail",Default=true})bI:AddSlider("AP_FailWindow",{Text="Fail Window",Default=0.25,Min=0,Max=1,Suffix=" s"})bI:AddToggle("AP_Debug",{Text="Debug Info",Default=false})bI:AddToggle("AP_AutoRefresh",{Text="Auto-Refresh (Local File)",Default=false})bI:AddButton({Text="Launch Config Builder",Func=function()local bQ="https://raw.githubusercontent.com/whodunitwww/noxhelpers/refs/heads/main/apBuilder.lua"loadstring(game:HttpGet(bQ))()({GameDir=d.gameDir,DefaultConfig=L.AP_Config,DefaultExtra=L.AP_ConfigExtra,CounterEditEnabled=false})end})bI:AddButton({Text="Launch Anim Player",Func=function()loadstring(game:HttpGet("https://raw.githubusercontent.com/whodunitwww/noxhelpers/refs/heads/main/animPlayer.lua"))()end})g.AP_Enable:OnChanged(function(I)if I then L:Start()else L:Stop()end end)f.AP_Range:OnChanged(function(I)L.range=I;K.RangeSq=I*I end)g.AP_UseFov:OnChanged(function(I)L.useFov=I end)f.AP_FovLimit:OnChanged(function(I)L.fovLimit=I;K.FovThreshold=math.cos(math.rad(I/2))end)g.AP_Debug:OnChanged(function(I)L.debug=I end)g.AP_Ping:OnChanged(function(I)L.pingOn=I end)f.AP_PingScale:OnChanged(function(I)L.pingScale=I end)f.AP_Bias:OnChanged(function(I)L.extraBiasMs=I end)g.AP_RollOnFail:OnChanged(function(I)L.rollOnFailGlob=I end)f.AP_FailWindow:OnChanged(function(I)L.parryFailTime=I end)g.AP_AutoRefresh:OnChanged(function(I)bB.enabled=I;if I then local V=a4()local bC=V and not V.Url and type(V.Config)~="table"local bD=V and type(V.ExtraConfig)~="table"bB.lastMainSig=bC and bb(L.activeMainFile)or nil;bB.lastExtraSig=bD and bb(L.activeExtraFile)or nil end end)local bR=false;f.AP_ConfigProfile:OnChanged(function(bP)if bR then return end;for B,I in ipairs(L.ConfigPresets)do if I.Name==bP then if U(I)and not W(I,L.PaidKeys)then bK(I)local bS=L.lastPresetName;if not bS then bS=(L.ConfigPresets[a2()]or{}).Name end;bR=true;f.AP_ConfigProfile:SetValue(bS)bR=false;return end;L.currentPresetIndex=B;local bG,bg=bq()L.lastPresetName=I.Name;if bB.enabled then local V=a4()local bC=V and not V.Url and type(V.Config)~="table"local bD=V and type(V.ExtraConfig)~="table"bB.lastMainSig=bC and bb(L.activeMainFile)or nil;bB.lastExtraSig=bD and bb(L.activeExtraFile)or nil end;if e.Notify then e:Notify(("Switched: %s (%d anims)"):format(bG,bg),3)end;break end end end)if h then h:Register(function()L:Stop()for _,bg in ipairs(K.MainConnections)do if bg and bg.Disconnect then pcall(bg.Disconnect,bg)end end;for aR,_ in pairs(K.EnemyTracks)do L:unhookHumanoid(aR)end;table.clear(K.MainConnections)table.clear(K.PendingParries)end)end;return{}end
