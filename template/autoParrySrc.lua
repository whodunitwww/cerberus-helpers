return function(a)local b=a.Services;local c=a.Tabs;local d=a.References;local e=a.Library;local f=a.Options;local g=a.Toggles;local h=a.Unloader;local i=a.AutoParryConfig or{Enabled=false}local j=b.VirtualInputManager;local k=b.RunService;local l=b.Workspace;local m=b.HttpService;local n=b.Players;local o=os.clock;local p,q=table.insert,table.remove;if i.Enabled~=true then return end;local r={MainConnections={},EnemyTracks={},AnimSeen=setmetatable({},{__mode="k"}),PendingParries={},RangeSq=14*14,FovThreshold=-1,ParryAvailTime=0}local s={ConfigPresets={{Name="Custom Config",Url=nil}},enabled=false,debug=false,pingOn=true,pingScale=100,extraBiasMs=0,range=14,useFov=false,fovLimit=180,parryFailTime=0.25,rollOnFailGlob=true,productionMode=true,keyCode=Enum.KeyCode.F,rollKey=Enum.KeyCode.Q,currentPresetIndex=1,apFile=d.gameDir.."/AP_Config.json",apExtraFile=d.gameDir.."/AP_Config_Extra.json",AP_Config_Default={["17030773401"]={name="Zombie Attack",startSec=0.42,hold=0.30,rollOnFail=true,distanceAdj=0}},AP_ConfigExtra_Default={parryKey="F",rollKey="Q"},AP_Config={},AP_ConfigExtra={}}local function t(u,v)local w,x,y=u.X-v.X,u.Y-v.Y,u.Z-v.Z;return w*w+x*x+y*y end;local function z(A,B)if not s.useFov then return true end;if not A or not B then return false end;local C=(B.Position-A.Position).Unit;local D=A.CFrame.LookVector;return D:Dot(C)>=r.FovThreshold end;local function E(F,G,H)if not s.debug or not e.Notify then return end;e:Notify({Title=F,Description=G or"",Time=H or 3})end;local function I(J)if J then p(r.MainConnections,J)end;return J end;local function K()if not d.humanoidRootPart then return end;local L=o()for M=#r.PendingParries,1,-1 do local N=r.PendingParries[M]if L>=N.triggerTime then local O,P=pcall(N.fn)if not O and s.debug then warn("[AutoParry] Exec Error:",P)end;q(r.PendingParries,M)end end end;I(k.Heartbeat:Connect(K))I(d.player.CharacterAdded:Connect(function()table.clear(r.PendingParries)if s.debug then E("Respawn","Queue Cleared",2)end end))local function Q(R,S)j:SendKeyEvent(true,R,false,game)task.spawn(function()task.wait(S)j:SendKeyEvent(false,R,false,game)end)end;function s:executeParry(T,U,V,W,X)if not self.enabled then return end;local A=d.humanoidRootPart;if not A then return end;local L=o()local Y=V and V.Name or"Unknown"if L<r.ParryAvailTime then if self.rollOnFailGlob and T.rollOnFail then Q(self.rollKey,0.05)r.ParryAvailTime=L+self.parryFailTime;if getgenv().AutoParry_OnParryFailRoll then pcall(getgenv().AutoParry_OnParryFailRoll,U,T,Y,X)end;if not self.productionMode then E("Roll","Conflict/CD: "..(T.name or U),2)end end;return end;if self.useFov and V then local Z=V:FindFirstChild("HumanoidRootPart")or V.PrimaryPart;if not z(A,Z)then if self.debug then E("FOV Fail","Enemy outside angle",1)end;return end end;local _=T.priority=="roll"local a0=_ and self.rollKey or self.keyCode;Q(a0,T.hold)r.ParryAvailTime=L+self.parryFailTime;if getgenv().AutoParry_OnParryFired then pcall(getgenv().AutoParry_OnParryFired,U,T,Y,X)end;if not self.productionMode then E(_ and"Roll"or"Parry",T.name or U,2)end end;function s:schedule(U,a1,V,T)local L=o()local a2=d.player:GetNetworkPing()local a3=self.pingOn and a2*0.5*self.pingScale/100 or 0;a3=math.max(0,a3+self.extraBiasMs/1000)local a4=a1.TimePosition or 0;local a5={{t=T.startSec,isRepeat=false}}if T.repeats then for a6,a7 in ipairs(T.repeats)do p(a5,{t=tonumber(a7),isRepeat=true})end end;local a8=0;if T.distanceAdj~=0 and V and d.humanoidRootPart then local Z=V:FindFirstChild("HumanoidRootPart")or V.PrimaryPart;if Z then local a9=(Z.Position-d.humanoidRootPart.Position).Magnitude;a8=T.distanceAdj*a9/100 end end;local X=tostring(U).."-"..tostring(math.floor(L*1000))local Y=V and V.Name or"Unknown"for a6,aa in ipairs(a5)do local ab=(aa.t or T.startSec)+a8;local ac=ab-a4-a3;if getgenv().AutoParry_OnParryScheduled then pcall(getgenv().AutoParry_OnParryScheduled,U,T,Y,ac,L,X)end;p(r.PendingParries,{triggerTime=L+math.max(0,ac),fn=function()if V and V.Parent then self:executeParry(T,U,V,aa.isRepeat,X)end end})if not self.productionMode and self.debug then E("Scheduled",("%.3fs delay"):format(ac),1)end end end;function s:unhookHumanoid(ad)if r.EnemyTracks[ad]then for a6,J in ipairs(r.EnemyTracks[ad])do if J.Connected then J:Disconnect()end end;r.EnemyTracks[ad]=nil end end;function s:isValidTarget(ae)if not ae or ae==d.character then return false end;local Z=ae:FindFirstChild("HumanoidRootPart")or ae.PrimaryPart;local A=d.humanoidRootPart;if not(Z and A)then return false end;if t(Z.Position,A.Position)>r.RangeSq then return false end;return true end;function s:processAnim(af)if not af then return end;local ad=af.Parent;if not ad then return end;if r.EnemyTracks[ad]then return end;local ag={}local ah=ad.AnimationPlayed:Connect(function(ai)if not self.enabled then return end;if r.AnimSeen[ai]then return end;local ae=ad.Parent;if not self:isValidTarget(ae)then return end;local aj=ai.Animation and ai.Animation.AnimationId or""local U=aj:match("%d+")if not U then return end;local T=self.AP_Config[U]if not T or T.enabled==false then return end;r.AnimSeen[ai]=true;self:schedule(U,ai,ae,T)end)p(ag,ah)local ak=ad.AncestryChanged:Connect(function(a6,al)if not al then self:unhookHumanoid(ad)end end)p(ag,ak)r.EnemyTracks[ad]=ag end;function s:Start()if self.enabled then return end;self.enabled=true;for a6,am in ipairs(l:GetDescendants())do if am:IsA("Animator")then self:processAnim(am)end end;if not self.descAdd then self.descAdd=I(l.DescendantAdded:Connect(function(am)if am:IsA("Animator")then self:processAnim(am)end end))end;E("Auto Parry","Enabled",2)end;function s:Stop()self.enabled=false;table.clear(r.PendingParries)E("Auto Parry","Disabled",2)end;local function an(ao)if not(isfile and isfile(ao))then return nil end;local ap,aq=pcall(readfile,ao)return ap and type(aq)=="string"and aq or nil end;local function ar(ao)local as=an(ao)return as and tostring(#as)..":"..string.sub(as,1,64)or"nil"end;local function at(au)local av={}for aw,as in pairs(au)do if type(as)=="table"then av[aw]={name=as.name or"Unknown",startSec=tonumber(as.startSec)or 0,hold=tonumber(as.hold)or 0.35,rollOnFail=as.rollOnFail~=false,distanceAdj=tonumber(as.distanceAdj)or 0,repeats=as.repeats or{},priority=tostring(as.priority or"parry"):lower(),enabled=as.enabled~=false}end end;return av end;local function ax()local ay=s.ConfigPresets[s.currentPresetIndex]or s.ConfigPresets[1]local az,aA=s.AP_Config_Default,s.AP_ConfigExtra_Default;local aB,aC="default",0;if ay.Url then local O,aD=pcall(game.HttpGet,game,ay.Url)if O then local aE,as=pcall(m.JSONDecode,m,aD)if aE then az=at(as)aB="Web: "..ay.Name end end elseif isfile(s.apFile)then local G=an(s.apFile)if G then local aE,as=pcall(m.JSONDecode,m,G)if aE then az=at(as)aB="File: Custom"end end end;s.AP_Config=az;if isfile(s.apExtraFile)then local G=an(s.apExtraFile)if G then local aE,as=pcall(m.JSONDecode,m,G)if aE then aA=as end end end;s.AP_ConfigExtra=aA;local aF=s.AP_ConfigExtra.parryKey or"F"local aG=s.AP_ConfigExtra.rollKey or"Q"s.keyCode=Enum.KeyCode[aF:upper()]or Enum.KeyCode.F;s.rollKey=Enum.KeyCode[aG:upper()]or Enum.KeyCode.Q;for a6 in pairs(s.AP_Config)do aC=aC+1 end;return aB,aC end;ax()getgenv()._AP_AUTOREFRESH=getgenv()._AP_AUTOREFRESH or{}local aH=getgenv()._AP_AUTOREFRESH;if not aH._started then aH._started=true;aH.enabled=false;aH.lastMainSig=nil;aH.lastExtraSig=nil;task.spawn(function()while true do task.wait(1)if aH.enabled and aH.Callback then pcall(aH.Callback)end end end)end;aH.Callback=function()local aI=s.ConfigPresets[s.currentPresetIndex].Url==nil;local aJ=aI and ar(s.apFile)or aH.lastMainSig;local aK=ar(s.apExtraFile)if aJ~=aH.lastMainSig or aK~=aH.lastExtraSig then aH.lastMainSig=aJ;aH.lastExtraSig=aK;local aL,aM=ax()if e and e.Notify then e:Notify({Title="AutoParry Refreshed",Description=("%s (%d Anims)"):format(aL,aM),Time=4})end end end;local aN=c.Combat:AddRightGroupbox("Auto Parry","swords")aN:AddToggle("AP_Enable",{Text="Enable Auto Parry",Default=false}):AddKeyPicker("AP_ToggleKey",{Default=nil,SyncToggleState=true,Mode="Toggle"})aN:AddDropdown('AP_ConfigProfile',{Values=(function()local aO={}for a6,am in ipairs(s.ConfigPresets)do table.insert(aO,am.Name)end;return aO end)(),Default=1,Multi=false,Text='Config Profile'})aN:AddSlider("AP_Range",{Text="Range",Default=14,Min=5,Max=50,Suffix=" studs"})aN:AddDivider()aN:AddToggle("AP_UseFov",{Text="Use FOV Check",Default=false})aN:AddSlider("AP_FovLimit",{Text="FOV Angle",Default=180,Min=45,Max=360,Suffix=" deg"})aN:AddDivider()aN:AddToggle("AP_Ping",{Text="Ping Compensation",Default=true})aN:AddSlider("AP_PingScale",{Text="Ping Scale",Default=100,Min=0,Max=150,Suffix="%"})aN:AddSlider("AP_Bias",{Text="Extra Bias",Default=0,Min=-150,Max=150,Suffix=" ms"})aN:AddDivider()aN:AddToggle("AP_RollOnFail",{Text="Roll on Fail",Default=true})aN:AddSlider("AP_FailWindow",{Text="Fail Window",Default=0.25,Min=0,Max=1,Suffix=" s"})aN:AddToggle("AP_Debug",{Text="Debug Info",Default=false})aN:AddToggle("AP_AutoRefresh",{Text="Auto-Refresh (Local File)",Default=false})aN:AddButton({Text="Launch Config Builder",Func=function()local aP="https://raw.githubusercontent.com/whodunitwww/noxhelpers/refs/heads/main/apBuilder.lua"loadstring(game:HttpGet(aP))()({GameDir=d.gameDir,DefaultConfig=s.AP_Config,DefaultExtra=s.AP_ConfigExtra,CounterEditEnabled=false})end})aN:AddButton({Text="Launch Anim Player",Func=function()loadstring(game:HttpGet("https://raw.githubusercontent.com/whodunitwww/noxhelpers/refs/heads/main/animPlayer.lua"))()end})g.AP_Enable:OnChanged(function(am)if am then s:Start()else s:Stop()end end)f.AP_Range:OnChanged(function(am)s.range=am;r.RangeSq=am*am end)g.AP_UseFov:OnChanged(function(am)s.useFov=am end)f.AP_FovLimit:OnChanged(function(am)s.fovLimit=am;r.FovThreshold=math.cos(math.rad(am/2))end)g.AP_Debug:OnChanged(function(am)s.debug=am end)g.AP_Ping:OnChanged(function(am)s.pingOn=am end)f.AP_PingScale:OnChanged(function(am)s.pingScale=am end)f.AP_Bias:OnChanged(function(am)s.extraBiasMs=am end)g.AP_RollOnFail:OnChanged(function(am)s.rollOnFailGlob=am end)f.AP_FailWindow:OnChanged(function(am)s.parryFailTime=am end)g.AP_AutoRefresh:OnChanged(function(am)aH.enabled=am;if am then aH.lastMainSig=ar(s.apFile)aH.lastExtraSig=ar(s.apExtraFile)end end)f.AP_ConfigProfile:OnChanged(function(aQ)for M,am in ipairs(s.ConfigPresets)do if am.Name==aQ then s.currentPresetIndex=M;local aL,aR=ax()if e.Notify then e:Notify(("Switched: %s (%d anims)"):format(aL,aR),3)end;break end end end)if h then h:Register(function()s:Stop()for a6,aR in ipairs(r.MainConnections)do if aR and aR.Disconnect then pcall(aR.Disconnect,aR)end end;for ad,a6 in pairs(r.EnemyTracks)do s:unhookHumanoid(ad)end;table.clear(r.MainConnections)table.clear(r.PendingParries)end)end;return{}end
