return function(a)local b=a.Services;local c=a.Tabs;local d=a.References;local e=a.Library;local f=a.Options;local g=a.Toggles;local h=a.Unloader;local i=a.AutoParryConfig or{Enabled=false}local j=b.VirtualInputManager;local k=b.RunService;local l=b.Workspace;local m=b.HttpService;local n=b.Players;local o=os.clock;local p,q=table.insert,table.remove;local function r(s,t)if type(s)~="string"or s==""then return t end;if s:find("/")or s:find("\\")then return s end;return d.gameDir.."/"..s end;local function u(v)local w={}if type(v)=="table"then for x,y in ipairs(v)do if type(y)=="table"then local z=tostring(y.Name or y.name or"Preset "..x)w[#w+1]={Name=z,Url=y.Url or y.url,EncryptedUrl=y.EncryptedUrl or y.encryptedUrl or y.EncryptedURL or y.encryptedURL,File=y.File or y.file,EncryptedExtraUrl=y.EncryptedExtraUrl or y.encryptedExtraUrl or y.EncryptedExtraURL or y.encryptedExtraURL,ExtraFile=y.ExtraFile or y.extraFile,Config=y.Config or y.config,ExtraConfig=y.ExtraConfig or y.extraConfig,Default=y.Default==true or y.default==true}end end end;if#w==0 then w[1]={Name="Custom Config",File="AP_Config.json",ExtraFile="AP_Config_Extra.json",Default=true}end;return w end;local function A(B)local C={}if type(B)=="table"then for D,E in pairs(B)do C[D]=E end end;return C end;if i.Enabled~=true then return end;local F={MainConnections={},EnemyTracks={},AnimSeen=setmetatable({},{__mode="k"}),PendingParries={},RangeSq=14*14,FovThreshold=-1,ParryAvailTime=0}local G={ConfigPresets=u(i.Presets or i.ConfigPresets),DefaultConfig=type(i.DefaultConfig)=="table"and i.DefaultConfig or{},DefaultExtra=type(i.DefaultExtra)=="table"and i.DefaultExtra or{parryKey="F",rollKey="Q"},secretKey=a.AutoParrySecrets and(a.AutoParrySecrets.Key or a.AutoParrySecrets.AutoParryKey)or nil,enabled=false,debug=false,pingOn=true,pingScale=100,extraBiasMs=0,range=14,useFov=false,fovLimit=180,parryFailTime=0.25,rollOnFailGlob=true,productionMode=true,keyCode=Enum.KeyCode.F,rollKey=Enum.KeyCode.Q,currentPresetIndex=1,apFile=d.gameDir.."/AP_Config.json",apExtraFile=d.gameDir.."/AP_Config_Extra.json",activeMainFile=nil,activeExtraFile=nil,AP_Config={},AP_ConfigExtra={}}local function H()local I=i.DefaultPreset;if type(I)=="number"and G.ConfigPresets[I]then return I end;if type(I)=="string"then for x,J in ipairs(G.ConfigPresets)do if J.Name==I then return x end end end;for x,J in ipairs(G.ConfigPresets)do if J.Default==true then return x end end;return 1 end;local function K()return G.ConfigPresets[G.currentPresetIndex]or G.ConfigPresets[1]end;local function L(J)local M=r(J and J.File,G.apFile)local N=r(J and J.ExtraFile,G.apExtraFile)return M,N end;G.currentPresetIndex=H()local function O(P,Q)local R,S,T=P.X-Q.X,P.Y-Q.Y,P.Z-Q.Z;return R*R+S*S+T*T end;local function U(V,W)if not G.useFov then return true end;if not V or not W then return false end;local X=(W.Position-V.Position).Unit;local Y=V.CFrame.LookVector;return Y:Dot(X)>=F.FovThreshold end;local function Z(_,a0,a1)if not G.debug or not e.Notify then return end;e:Notify({Title=_,Description=a0 or"",Time=a1 or 3})end;local function a2(a3)if a3 then p(F.MainConnections,a3)end;return a3 end;local function a4()if not d.humanoidRootPart then return end;local a5=o()for x=#F.PendingParries,1,-1 do local a6=F.PendingParries[x]if a5>=a6.triggerTime then local a7,a8=pcall(a6.fn)if not a7 and G.debug then warn("[AutoParry] Exec Error:",a8)end;q(F.PendingParries,x)end end end;a2(k.Heartbeat:Connect(a4))a2(d.player.CharacterAdded:Connect(function()table.clear(F.PendingParries)if G.debug then Z("Respawn","Queue Cleared",2)end end))local function a9(aa,ab)j:SendKeyEvent(true,aa,false,game)task.spawn(function()task.wait(ab)j:SendKeyEvent(false,aa,false,game)end)end;function G:executeParry(ac,ad,ae,af,ag)if not self.enabled then return end;local V=d.humanoidRootPart;if not V then return end;local a5=o()local ah=ae and ae.Name or"Unknown"if a5<F.ParryAvailTime then if self.rollOnFailGlob and ac.rollOnFail then a9(self.rollKey,0.05)F.ParryAvailTime=a5+self.parryFailTime;if getgenv().AutoParry_OnParryFailRoll then pcall(getgenv().AutoParry_OnParryFailRoll,ad,ac,ah,ag)end;if not self.productionMode then Z("Roll","Conflict/CD: "..(ac.name or ad),2)end end;return end;if self.useFov and ae then local ai=ae:FindFirstChild("HumanoidRootPart")or ae.PrimaryPart;if not U(V,ai)then if self.debug then Z("FOV Fail","Enemy outside angle",1)end;return end end;local aj=ac.priority=="roll"local ak=aj and self.rollKey or self.keyCode;a9(ak,ac.hold)F.ParryAvailTime=a5+self.parryFailTime;if getgenv().AutoParry_OnParryFired then pcall(getgenv().AutoParry_OnParryFired,ad,ac,ah,ag)end;if not self.productionMode then Z(aj and"Roll"or"Parry",ac.name or ad,2)end end;function G:schedule(ad,al,ae,ac)local a5=o()local am=d.player:GetNetworkPing()local an=self.pingOn and am*0.5*self.pingScale/100 or 0;an=math.max(0,an+self.extraBiasMs/1000)local ao=al.TimePosition or 0;local ap={{t=ac.startSec,isRepeat=false}}if ac.repeats then for aq,ar in ipairs(ac.repeats)do p(ap,{t=tonumber(ar),isRepeat=true})end end;local as=0;if ac.distanceAdj~=0 and ae and d.humanoidRootPart then local ai=ae:FindFirstChild("HumanoidRootPart")or ae.PrimaryPart;if ai then local at=(ai.Position-d.humanoidRootPart.Position).Magnitude;as=ac.distanceAdj*at/100 end end;local ag=tostring(ad).."-"..tostring(math.floor(a5*1000))local ah=ae and ae.Name or"Unknown"for aq,au in ipairs(ap)do local av=(au.t or ac.startSec)+as;local aw=av-ao-an;if getgenv().AutoParry_OnParryScheduled then pcall(getgenv().AutoParry_OnParryScheduled,ad,ac,ah,aw,a5,ag)end;p(F.PendingParries,{triggerTime=a5+math.max(0,aw),fn=function()if ae and ae.Parent then self:executeParry(ac,ad,ae,au.isRepeat,ag)end end})if not self.productionMode and self.debug then Z("Scheduled",("%.3fs delay"):format(aw),1)end end end;function G:unhookHumanoid(ax)if F.EnemyTracks[ax]then for aq,a3 in ipairs(F.EnemyTracks[ax])do if a3.Connected then a3:Disconnect()end end;F.EnemyTracks[ax]=nil end end;function G:isValidTarget(ay)if not ay or ay==d.character then return false end;local ai=ay:FindFirstChild("HumanoidRootPart")or ay.PrimaryPart;local V=d.humanoidRootPart;if not(ai and V)then return false end;if O(ai.Position,V.Position)>F.RangeSq then return false end;return true end;function G:processAnim(az)if not az then return end;local ax=az.Parent;if not ax then return end;if F.EnemyTracks[ax]then return end;local aA={}local aB=ax.AnimationPlayed:Connect(function(aC)if not self.enabled then return end;if F.AnimSeen[aC]then return end;local ay=ax.Parent;if not self:isValidTarget(ay)then return end;local aD=aC.Animation and aC.Animation.AnimationId or""local ad=aD:match("%d+")if not ad then return end;local ac=self.AP_Config[ad]if not ac or ac.enabled==false then return end;F.AnimSeen[aC]=true;self:schedule(ad,aC,ay,ac)end)p(aA,aB)local aE=ax.AncestryChanged:Connect(function(aq,aF)if not aF then self:unhookHumanoid(ax)end end)p(aA,aE)F.EnemyTracks[ax]=aA end;function G:Start()if self.enabled then return end;self.enabled=true;for aq,E in ipairs(l:GetDescendants())do if E:IsA("Animator")then self:processAnim(E)end end;if not self.descAdd then self.descAdd=a2(l.DescendantAdded:Connect(function(E)if E:IsA("Animator")then self:processAnim(E)end end))end;Z("Auto Parry","Enabled",2)end;function G:Stop()self.enabled=false;table.clear(F.PendingParries)Z("Auto Parry","Disabled",2)end;local function aG(s)if not(isfile and isfile(s))then return nil end;local aH,aI=pcall(readfile,s)return aH and type(aI)=="string"and aI or nil end;local function aJ(aI)if type(aI)~="string"then return nil end;local aH,aK=pcall(function()if crypt and crypt.base64 and crypt.base64.decode then return crypt.base64.decode(aI)elseif bit and bit.base64 and bit.base64.decode then return bit.base64.decode(aI)end;return m:JSONDecode('"'..aI..'"')end)if aH and type(aK)=="string"then return aK end;return nil end;local function aL(aM,aa)if type(aM)~="string"or aM==""then return nil end;if type(aa)~="string"or aa==""then return nil end;if not(bit32 and bit32.bxor)then return nil end;local aN=table.create(#aM)local aO=#aa;for x=1,#aM do local aP=string.byte(aM,x,x)local D=string.byte(aa,(x-1)%aO+1,(x-1)%aO+1)aN[x]=string.char(bit32.bxor(aP,D))end;return table.concat(aN)end;local function aQ(aR,aa)if type(aR)~="string"then return nil,"invalid payload"end;if type(aa)~="string"or aa==""then return nil,"missing key"end;local aM=aJ(aR)if not aM then return nil,"base64 decode failed"end;local aS=aL(aM,aa)if not aS then return nil,"xor decrypt failed"end;return aS end;local function aT(s)local aU=aG(s)return aU and tostring(#aU)..":"..string.sub(aU,1,64)or"nil"end;local function aV(aW)local aX={}for aY,aU in pairs(aW)do if type(aU)=="table"then aX[aY]={name=aU.name or"Unknown",startSec=tonumber(aU.startSec)or 0,hold=tonumber(aU.hold)or 0.35,rollOnFail=aU.rollOnFail~=false,distanceAdj=tonumber(aU.distanceAdj)or 0,repeats=aU.repeats or{},priority=tostring(aU.priority or"parry"):lower(),enabled=aU.enabled~=false}end end;return aX end;local function aZ()local a_=K()local b0=aV(G.DefaultConfig)local b1=A(G.DefaultExtra)local b2,b3="default",0;local M,N=L(a_)G.activeMainFile=M;G.activeExtraFile=N;if a_ and type(a_.Config)=="table"then b0=aV(a_.Config)b2="Injected: "..a_.Name elseif a_ and a_.EncryptedUrl then local a7,b4=pcall(game.HttpGet,game,a_.EncryptedUrl)if a7 then local b5=b4:gsub("%s+","")local aS,b6=aQ(b5,G.secretKey)if aS then local b7,aU=pcall(m.JSONDecode,m,aS)if b7 then b0=aV(aU)b2=a_.Name else warn("[AutoParry] Encrypted config JSON invalid.")end else warn("[AutoParry] Encrypted config decrypt failed: "..tostring(b6))end end elseif a_ and a_.Url then local a7,b4=pcall(game.HttpGet,game,a_.Url)if a7 then local b7,aU=pcall(m.JSONDecode,m,b4)if b7 then b0=aV(aU)b2="Web: "..a_.Name end end elseif M and isfile(M)then local a0=aG(M)if a0 then local b7,aU=pcall(m.JSONDecode,m,a0)if b7 then b0=aV(aU)b2="File: "..(a_ and a_.Name or"Custom")end end end;G.AP_Config=b0;if a_ and type(a_.ExtraConfig)=="table"then for D,E in pairs(a_.ExtraConfig)do b1[D]=E end elseif a_ and a_.EncryptedExtraUrl then local a7,b4=pcall(game.HttpGet,game,a_.EncryptedExtraUrl)if a7 then local b5=b4:gsub("%s+","")local aS,b6=aQ(b5,G.secretKey)if aS then local b7,aU=pcall(m.JSONDecode,m,aS)if b7 and type(aU)=="table"then for D,E in pairs(aU)do b1[D]=E end end else warn("[AutoParry] Encrypted extra decrypt failed: "..tostring(b6))end end elseif N and isfile(N)then local a0=aG(N)if a0 then local b7,aU=pcall(m.JSONDecode,m,a0)if b7 and type(aU)=="table"then for D,E in pairs(aU)do b1[D]=E end end end end;G.AP_ConfigExtra=b1;local b8=G.AP_ConfigExtra.parryKey or"F"local b9=G.AP_ConfigExtra.rollKey or"Q"G.keyCode=Enum.KeyCode[b8:upper()]or Enum.KeyCode.F;G.rollKey=Enum.KeyCode[b9:upper()]or Enum.KeyCode.Q;for aq in pairs(G.AP_Config)do b3=b3+1 end;return b2,b3 end;aZ()getgenv()._AP_AUTOREFRESH=getgenv()._AP_AUTOREFRESH or{}local ba=getgenv()._AP_AUTOREFRESH;if not ba._started then ba._started=true;ba.enabled=false;ba.lastMainSig=nil;ba.lastExtraSig=nil;task.spawn(function()while true do task.wait(1)if ba.enabled and ba.Callback then pcall(ba.Callback)end end end)end;ba.Callback=function()local J=K()local bb=J and not J.Url and type(J.Config)~="table"local bc=J and type(J.ExtraConfig)~="table"local bd=bb and aT(G.activeMainFile)or ba.lastMainSig;local be=bc and aT(G.activeExtraFile)or ba.lastExtraSig;if bd~=ba.lastMainSig or be~=ba.lastExtraSig then ba.lastMainSig=bd;ba.lastExtraSig=be;local bf,bg=aZ()if e and e.Notify then e:Notify({Title="AutoParry Refreshed",Description=("%s (%d Anims)"):format(bf,bg),Time=4})end end end;local bh=c.Combat:AddRightGroupbox("Auto Parry","swords")bh:AddToggle("AP_Enable",{Text="Enable Auto Parry",Default=false}):AddKeyPicker("AP_ToggleKey",{Default=nil,SyncToggleState=true,Mode="Toggle"})bh:AddDropdown('AP_ConfigProfile',{Values=(function()local bi={}for aq,E in ipairs(G.ConfigPresets)do table.insert(bi,E.Name)end;return bi end)(),Default=(G.ConfigPresets[G.currentPresetIndex]or G.ConfigPresets[1]).Name,Multi=false,Text='Config Profile'})bh:AddSlider("AP_Range",{Text="Range",Default=14,Min=5,Max=50,Suffix=" studs"})bh:AddDivider()bh:AddToggle("AP_UseFov",{Text="Use FOV Check",Default=false})bh:AddSlider("AP_FovLimit",{Text="FOV Angle",Default=180,Min=45,Max=360,Suffix=" deg"})bh:AddDivider()bh:AddToggle("AP_Ping",{Text="Ping Compensation",Default=true})bh:AddSlider("AP_PingScale",{Text="Ping Scale",Default=100,Min=0,Max=150,Suffix="%"})bh:AddSlider("AP_Bias",{Text="Extra Bias",Default=0,Min=-150,Max=150,Suffix=" ms"})bh:AddDivider()bh:AddToggle("AP_RollOnFail",{Text="Roll on Fail",Default=true})bh:AddSlider("AP_FailWindow",{Text="Fail Window",Default=0.25,Min=0,Max=1,Suffix=" s"})bh:AddToggle("AP_Debug",{Text="Debug Info",Default=false})bh:AddToggle("AP_AutoRefresh",{Text="Auto-Refresh (Local File)",Default=false})bh:AddButton({Text="Launch Config Builder",Func=function()local bj="https://raw.githubusercontent.com/whodunitwww/noxhelpers/refs/heads/main/apBuilder.lua"loadstring(game:HttpGet(bj))()({GameDir=d.gameDir,DefaultConfig=G.AP_Config,DefaultExtra=G.AP_ConfigExtra,CounterEditEnabled=false})end})bh:AddButton({Text="Launch Anim Player",Func=function()loadstring(game:HttpGet("https://raw.githubusercontent.com/whodunitwww/noxhelpers/refs/heads/main/animPlayer.lua"))()end})g.AP_Enable:OnChanged(function(E)if E then G:Start()else G:Stop()end end)f.AP_Range:OnChanged(function(E)G.range=E;F.RangeSq=E*E end)g.AP_UseFov:OnChanged(function(E)G.useFov=E end)f.AP_FovLimit:OnChanged(function(E)G.fovLimit=E;F.FovThreshold=math.cos(math.rad(E/2))end)g.AP_Debug:OnChanged(function(E)G.debug=E end)g.AP_Ping:OnChanged(function(E)G.pingOn=E end)f.AP_PingScale:OnChanged(function(E)G.pingScale=E end)f.AP_Bias:OnChanged(function(E)G.extraBiasMs=E end)g.AP_RollOnFail:OnChanged(function(E)G.rollOnFailGlob=E end)f.AP_FailWindow:OnChanged(function(E)G.parryFailTime=E end)g.AP_AutoRefresh:OnChanged(function(E)ba.enabled=E;if E then local J=K()local bb=J and not J.Url and type(J.Config)~="table"local bc=J and type(J.ExtraConfig)~="table"ba.lastMainSig=bb and aT(G.activeMainFile)or nil;ba.lastExtraSig=bc and aT(G.activeExtraFile)or nil end end)f.AP_ConfigProfile:OnChanged(function(bk)for x,E in ipairs(G.ConfigPresets)do if E.Name==bk then G.currentPresetIndex=x;local bf,bl=aZ()if ba.enabled then local J=K()local bb=J and not J.Url and type(J.Config)~="table"local bc=J and type(J.ExtraConfig)~="table"ba.lastMainSig=bb and aT(G.activeMainFile)or nil;ba.lastExtraSig=bc and aT(G.activeExtraFile)or nil end;if e.Notify then e:Notify(("Switched: %s (%d anims)"):format(bf,bl),3)end;break end end end)if h then h:Register(function()G:Stop()for aq,bl in ipairs(F.MainConnections)do if bl and bl.Disconnect then pcall(bl.Disconnect,bl)end end;for ax,aq in pairs(F.EnemyTracks)do G:unhookHumanoid(ax)end;table.clear(F.MainConnections)table.clear(F.PendingParries)end)end;return{}end
