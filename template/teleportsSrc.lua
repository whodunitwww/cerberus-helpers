return function(a)local b=a.Services;local c=a.Tabs;local d=a.References;local e=a.Library;local f=a.Options;local g=a.Toggles;local h=a.Helpers;local i=a.Unloader;local j=a.TeleportsConfig;if j.Enabled~=true then return end;local k={}local function l(m)if m then k[#k+1]=m end end;local n=c.Main:AddLeftGroupbox("Teleports","move-3d")local o,p,q,r,s={},{},{},{},{}local t=d.gameDir.."/waypoints.json"local u=type(j.Categories)=="table"and j.Categories or{}local v,w,x={},{},{}for y,z in ipairs(u)do if type(z)=="table"and type(z.key)=="string"and z.key~=""then local A=type(z.label)=="string"and z.label~=""and z.label or z.key;v[#v+1]=A;w[A]=z;x[z.key]=z end end;if#v==0 then warn("[Teleports] No categories configured. Provide TeleportsConfig.Categories.")return end;local function B(C)return{x=C.X,y=C.Y,z=C.Z}end;local function D(E)if typeof(E)=="Vector3"then return E end;if type(E)=="table"then local F=E.x or E.X or E[1]local G=E.y or E.Y or E[2]local H=E.z or E.Z or E[3]if tonumber(F)and tonumber(G)and tonumber(H)then return Vector3.new(tonumber(F),tonumber(G),tonumber(H))end end;return nil end;if isfile and isfile(t)then local I,J=pcall(readfile,t)if I and J and#J>0 then local K,L=pcall(function()return b.HttpService:JSONDecode(J)end)if K and type(L)=="table"then local M=L.list or{}local N=L.order or{}local O=L.keybinds or{}q,r,s={},{},{}for P,Q in pairs(M)do local C=D(Q)if C then q[P]=C end end;for R=1,#N do local S=N[R]if q[S]then r[#r+1]=S end end;for P,T in pairs(O)do if q[P]then s[P]=tostring(T)end end;if#r==0 then for S in pairs(q)do r[#r+1]=S end;table.sort(r)end end end end;local function U()if not writefile then return end;local V={list={},order=r,keybinds=s}for P,C in pairs(q)do if typeof(C)=="Vector3"then V.list[P]=B(C)elseif type(C)=="table"then V.list[P]=C end end;pcall(function()writefile(t,b.HttpService:JSONEncode(V))end)end;local function W(X,Y)local Z,_=Y,1;while X[Z]do _=_+1;Z=("%s (%d)"):format(Y,_)end;X[Z]=true;return Z end;local function a0(a1)table.clear(o)table.clear(p)if type(a1.scan)=="function"then local I,a2=pcall(a1.scan,{Services=b,References=d,Helpers=h,Waypoints={list=q,order=r,keybinds=s}})if I and type(a2)=="table"then for Z,C in pairs(a2)do if type(Z)=="string"then local a3=D(C)if a3 then o[Z]=a3 end elseif type(C)=="table"then local P=C.name or C.label or C[1]local a3=D(C.position or C.pos or C[2])if type(P)=="string"and a3 then o[P]=a3 end end end end;return end;local a4=a1.type or a1.key;if a4=="players"then local X={}for y,a5 in ipairs(b.Players:GetPlayers())do if a5~=d.player then local a6=a5.Character;local a7=a6 and a6:FindFirstChild("HumanoidRootPart")if a7 then local Y=a5.DisplayName~=""and a5.DisplayName or a5.Name;o[W(X,Y)]=a7.Position end end end elseif a4=="monsters"then local a8=workspace:FindFirstChild("Debris")and workspace.Debris:FindFirstChild("Monsters")if not a8 then return end;local X={}for y,a9 in ipairs(a8:GetChildren())do if a9:IsA("Model")and a9:FindFirstChildOfClass("Humanoid")then local a3;local I,aa=pcall(a9.GetPivot,a9)if I and typeof(aa)=="CFrame"then a3=aa.Position end;if not a3 then local a7=a9:FindFirstChild("HumanoidRootPart")or a9:FindFirstChildWhichIsA("BasePart")a3=a7 and a7.Position end;if a3 then local ab=a9:FindFirstChild("DisplayName")local P=ab and ab:IsA("StringValue")and ab.Value or a9.Name or"Monster"o[W(X,P)]=a3;p[P]=a9 end end end elseif a4=="waypoints"then for R=1,#r do local Z=r[R]local C=q[Z]if C then o[Z]=C end end end end;local function ac(a1)local E={}local a4=a1.type or a1.key;if a4=="waypoints"then for R=1,#r do local Z=r[R]if o[Z]then E[#E+1]=Z end end else for _ in pairs(o)do E[#E+1]=_ end;table.sort(E)end;return E end;n:AddDropdown("TP_TravelMode",{Text="Travel Mode",Values={"Teleport","Flight"},Default="Teleport"})n:AddSlider("TP_TravelSpeed",{Text="Flight Speed",Default=250,Min=50,Max=1000,Rounding=0,Suffix=" studs/s"})n:AddToggle("TP_SafetyMode",{Text="Safety Mode",Default=false,Tooltip="Teleportion will be blocked if a player is within Safety Range, and flight travel will occur at Travelling Height."})n:AddSlider("TP_SafetyRange",{Text="Safety Range",Default=50,Min=10,Max=250,Rounding=0,Suffix=" studs"})n:AddSlider("TP_TravelHeight",{Text="Travelling Height",Default=-50,Min=-500,Max=500,Rounding=0,Suffix=" studs"})local function ad(a3,ae)ae=tonumber(ae)or 50;for y,a5 in ipairs(b.Players:GetPlayers())do if a5~=d.player then local a6=a5.Character;local a7=a6 and a6:FindFirstChild("HumanoidRootPart")if a7 then if(a7.Position-a3).Magnitude<=ae then return true,a5 end end end end;return false,nil end;local function af(a3,ag,ah)ag=ag or 3;local ai=os.clock()while os.clock()-ai<(ah or 12)do local a7=d.humanoidRootPart;if not a7 then return false end;if(a7.Position-a3).Magnitude<=ag then return true end;task.wait()end;return false end;local function aj(ak,al,am)if not d.humanoidRootPart then return end;local a7=d.humanoidRootPart;local an=a7.Position;local ao=math.max(10,tonumber(am)or 250)local ap=Vector3.new(an.X,al,an.Z)local aq=h.MoveToPos(ap,ao)af(ap,3,12)if aq then pcall(aq)end;local ar=Vector3.new(ak.X,al,ak.Z)local as=h.MoveToPos(ar,ao)af(ar,3,12)if as then pcall(as)end;local at=ak+Vector3.new(0,2,0)local au=h.MoveToPos(at,ao)af(at,3,12)if au then pcall(au)end end;local av=x[j.DefaultCategory]or w[j.DefaultCategory]or u[1]local aw=type(av.label)=="string"and av.label~=""and av.label or av.key;local function ax()return av and(av.type or av.key)end;local function ay()return ax()=="waypoints"end;a0(av)local az=ac(av)local aA=az[1]local aB=n:AddDropdown("TP_Category",{Text="Category",Values=v,Default=aw})local aC=n:AddDropdown("TP_Location",{Text="Select Location",Values=az,Default=aA})local function aD(aE)local aF=aE and aC.Value or aA;a0(av)az=ac(av)if#az==0 then aA=nil;aC:SetValues({})aC:SetValue(nil)return end;if aF and table.find(az,aF)then aA=aF else aA=az[1]end;aC:SetValues(az)aC:SetValue(aA)end;aB:OnChanged(function(C)av=w[C]or x[C]or av;aD(false)end)aC:OnChanged(function(C)aA=C end)local function aG(aH)if not d.humanoidRootPart then return e:Notify("No character.",3)end;if not o[aH]then a0(av)if not ay()and q[aH]then o[aH]=q[aH]end end;local aI=o[aH]if not aI then return e:Notify("Invalid destination: "..tostring(aH),3)end;if g.TP_SafetyMode and g.TP_SafetyMode.Value then local aJ,aK=ad(aI,f.TP_SafetyRange.Value)if aJ then local S=aK and(aK.DisplayName~=""and aK.DisplayName or aK.Name)or"a player"return e:Notify(("Safety Mode: %s is within %d studs of the destination. Aborting."):format(S,tonumber(f.TP_SafetyRange.Value)or 0),5)end end;if f.TP_TravelMode.Value=="Teleport"then d.humanoidRootPart.CFrame=CFrame.new(aI+Vector3.new(0,3,0))else local ao=math.max(10,f.TP_TravelSpeed.Value or 250)if g.TP_SafetyMode and g.TP_SafetyMode.Value then local al=tonumber(f.TP_TravelHeight.Value)or d.humanoidRootPart.Position.Y+100;aj(aI,al,ao)else h.MoveToPos(aI+Vector3.new(0,3,0),ao)end end end;n:AddButton({Text="Teleport",Func=function()local aL=aC.Value or aA;if not aL then return e:Notify("No destination selected.",3)end;aG(aL)end})n:AddButton({Text="Refresh",Func=function()aD(true)end})n:AddDivider()n:AddInput("TP_WP_Name",{Text="Waypoint Name",Placeholder="My Waypoint",ClearTextOnFocus=false,Finished=false})local function aM(aN)return tostring(aN or""):gsub("^%s+",""):gsub("%s+$","")end;n:AddButton({Text="Add Waypoint",Tooltip="Adds a waypoint at your current location you can teleport too later.",Func=function()if not d.humanoidRootPart then return e:Notify("No character.",3)end;local Y=aM(f.TP_WP_Name.Value)if Y==""then Y="Waypoint"end;local P=Y;if q[P]~=nil then local X={}for y,_ in ipairs(r)do X[_]=true end;P=W(X,Y)end;q[P]=d.humanoidRootPart.Position;r[#r+1]=P;U()if ay()then aD(true)aC:SetValue(P)aA=P end;e:Notify("Added waypoint: "..P,3)end})n:AddButton({Text="Remove Waypoint",Tooltip="Removes the currently selected waypoint.",Func=function()if not ay()then return e:Notify("Switch to Waypoints to remove.",3)end;local aL=aC.Value or aA;if not aL or not q[aL]then return e:Notify("Select a waypoint to remove.",3)end;q[aL]=nil;s[aL]=nil;for R=#r,1,-1 do if r[R]==aL then table.remove(r,R)end end;U()aD(true)e:Notify("Removed waypoint: "..aL,3)end})if j.Waypoints.Enabled then n:AddDivider()n:AddLabel("Keybind Manager")n:AddToggle("TP_EnableKeybinds",{Text="Enable Waypoint Keybinds",Default=true,Tooltip="Globally enables or disables hotkeys for waypoints."})n:AddLabel("Key to Assign:"):AddKeyPicker("TP_Binder",{Default="None",SyncToggleState=false,Mode="Toggle",Text="Binder",NoUI=true})local function aO()local aL=aC.Value or aA;if ay()and aL and s[aL]then return"Current Bind: "..tostring(s[aL])end;return"Current Bind: None"end;local aP=n:AddLabel(aO())aC:OnChanged(function(C)aA=C;aP:SetText(aO())end)n:AddButton({Text="Assign Key to Selected",Tooltip="Assigns the key set in 'Binder' to the currently selected waypoint.",Func=function()if not ay()then return e:Notify("Can only assign binds to Waypoints.",3)end;local aL=aC.Value or aA;if not aL then return e:Notify("No waypoint selected.",3)end;local T=f.TP_Binder.Value;if T=="None"or T==nil then return e:Notify("Please press a key in the binder first.",3)end;s[aL]=T;U()aP:SetText(aO())e:Notify(string.format("Bound [%s] to '%s'",T,aL),3)end})n:AddButton({Text="Clear Keybind (Selected)",Func=function()if not ay()then return end;local aL=aC.Value or aA;if aL and s[aL]then s[aL]=nil;U()aP:SetText(aO())e:Notify("Cleared bind for "..aL,3)end end})n:AddButton({Text="Clear All Keybinds",Func=function()if next(s)==nil then return e:Notify("No keybinds to clear.",3)end;s={}U()aP:SetText(aO())e:Notify("All waypoint keybinds have been cleared.",3)end})l(b.UserInputService.InputBegan:Connect(function(aQ,aR)if aR then return end;if not g.TP_EnableKeybinds or not g.TP_EnableKeybinds.Value then return end;if aQ.UserInputType==Enum.UserInputType.Keyboard then local aS=aQ.KeyCode.Name;for aT,aU in pairs(s)do if aU==aS then aG(aT)return end end end end))end;if i then i:Register(function()for R=#k,1,-1 do local aV=k[R]k[R]=nil;pcall(function()if aV and aV.Disconnect then aV:Disconnect()end end)end end)end;return{}end
